# CI/CD Secrets Checklist

**Agent Orchestrator - Required Secrets for CI/CD Pipeline**

This checklist documents all secrets and environment variables needed for the CI/CD pipeline to function correctly.

---

## GitHub Actions Secrets

### Core Application Secrets

**Required for E2E tests**:

- [ ] `ANTHROPIC_API_KEY`
  - **Purpose**: Claude API access for orchestrator
  - **Where to get**: https://console.anthropic.com/
  - **Scope**: Repository secret
  - **Used in**: E2E tests that interact with LLM orchestration

- [ ] `OPENAI_API_KEY`
  - **Purpose**: GPT-4 API access (alternative LLM provider)
  - **Where to get**: https://platform.openai.com/api-keys
  - **Scope**: Repository secret
  - **Used in**: LLM factory tests

- [ ] `GITHUB_TOKEN`
  - **Purpose**: Git operations (automatic, provided by GitHub)
  - **Where to get**: Auto-generated by GitHub Actions
  - **Scope**: Automatic
  - **Used in**: Workflow file operations, artifact upload

### Optional Secrets

**Notification services**:

- [ ] `SLACK_WEBHOOK`
  - **Purpose**: Slack notifications on test failures
  - **Where to get**: https://api.slack.com/messaging/webhooks
  - **Scope**: Repository or organization secret
  - **Used in**: Notification step (if enabled)

**Advanced monitoring**:

- [ ] `SENTRY_DSN`
  - **Purpose**: Error tracking integration (if using Sentry)
  - **Where to get**: Sentry project settings
  - **Scope**: Repository secret
  - **Used in**: Error tracking in tests

---

## Environment Variables

### CI Pipeline Variables

These are set in `.github/workflows/test.yml` and typically don't need secrets:

- `NODE_ENV=test` - Test environment mode
- `API_BASE_URL=http://localhost:3000` - API endpoint for E2E tests
- `BURN_IN_ITERATIONS=10` - Number of burn-in loop iterations

### Test-Specific Variables

Set in `playwright.config.ts` or test files:

- `CI=true` - Indicates CI environment (auto-set by GitHub Actions)
- `PWTEST_SKIP_TEST_OUTPUT=1` - Reduce Playwright console output

---

## How to Configure Secrets

### Via GitHub UI

1. Navigate to repository: `https://github.com/{org}/{repo}`
2. Go to **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret**
4. Enter:
   - **Name**: `ANTHROPIC_API_KEY` (exact match from checklist)
   - **Value**: Your API key (paste without quotes)
5. Click **Add secret**
6. Repeat for each required secret

### Via GitHub CLI

```bash
gh secret set ANTHROPIC_API_KEY --body "your-api-key-here"
gh secret set OPENAI_API_KEY --body "your-api-key-here"
gh secret set SLACK_WEBHOOK --body "your-webhook-url-here"
```

---

## Security Best Practices

### API Keys

✅ **DO**:
- Rotate API keys quarterly
- Use read-only or limited-scope keys when possible
- Store keys as repository secrets (never commit to code)
- Use organization secrets for keys shared across repos

❌ **DON'T**:
- Commit keys to `.env` files
- Share keys via email or chat
- Use production keys in CI (use test/staging keys)
- Log secrets in CI output (GitHub auto-masks them)

### Access Control

✅ **DO**:
- Limit secret access to necessary workflows only
- Use environment-specific secrets (dev/staging/prod)
- Enable branch protection on main/develop
- Require PR approvals for workflow changes

❌ **DON'T**:
- Use the same keys for local dev and CI
- Grant workflow write permissions unnecessarily
- Skip code review for workflow file changes

---

## Secret Validation

### Testing Secrets

After adding secrets, validate they work:

1. **Trigger workflow**:
   ```bash
   git commit --allow-empty -m "test: validate CI secrets"
   git push
   ```

2. **Check workflow run**:
   - Go to Actions tab
   - Click on workflow run
   - Check for secret-related errors

3. **Common errors**:
   - `Error: Input required and not supplied: api-key` → Secret name mismatch
   - `401 Unauthorized` → Invalid API key
   - `Secret not found` → Secret not added or typo in name

### Local Validation

Before pushing, test locally with `.env`:

```bash
# Copy example
cp .env.example .env

# Add your keys
ANTHROPIC_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here

# Run tests
npm run test:e2e
```

**Important**: `.env` is gitignored - never commit this file

---

## Secret Rotation Schedule

| Secret | Rotation Frequency | Next Rotation |
|--------|-------------------|---------------|
| ANTHROPIC_API_KEY | Quarterly | [Date] |
| OPENAI_API_KEY | Quarterly | [Date] |
| SLACK_WEBHOOK | Annually | [Date] |
| GITHUB_TOKEN | Automatic | N/A |

### Rotation Procedure

1. Generate new key from provider
2. Update secret in GitHub Actions
3. Trigger test workflow to validate
4. Deactivate old key after 24 hours (grace period)
5. Update rotation schedule

---

## Debugging Secret Issues

### "Secret not available"

**Symptoms**: Workflow fails with `secret not found` or similar

**Causes**:
1. Secret not added to repository
2. Typo in secret name (case-sensitive!)
3. Workflow running in forked PR (secrets not shared with forks)

**Fix**:
- Verify secret exists in Settings → Secrets
- Check spelling in workflow file: `${{ secrets.ANTHROPIC_API_KEY }}`
- For forks, approve workflow run manually

### "API authentication failed"

**Symptoms**: Tests fail with 401/403 errors

**Causes**:
1. Invalid or expired API key
2. API key doesn't have required permissions
3. Rate limit exceeded

**Fix**:
- Regenerate API key from provider
- Check API key scope/permissions
- Monitor API usage quotas

### "Secret value contains invalid characters"

**Symptoms**: GitHub rejects secret value

**Causes**:
1. Leading/trailing whitespace in secret value
2. Special characters that need escaping

**Fix**:
- Trim whitespace before pasting
- Use GitHub CLI to set secret (handles escaping automatically)

---

## Secrets in Pull Requests

### Fork Behavior

**Security model**:
- Secrets are NOT available to workflows triggered by forked PRs
- This prevents malicious actors from stealing secrets via PR

**Workflow**:
1. External contributor opens PR
2. Workflow fails with "secret not available"
3. Maintainer reviews code
4. Maintainer approves workflow run manually
5. Workflow runs with secrets

### Same-Repo PRs

- Secrets are available automatically
- No manual approval needed
- Standard security still applies

---

## Emergency Procedures

### Compromised Secret

**If a secret is leaked or compromised**:

1. **Immediate**:
   - Delete secret from GitHub Actions
   - Revoke key at provider (Anthropic, OpenAI, etc.)
   - Generate new key

2. **Within 1 hour**:
   - Update secret in GitHub with new key
   - Audit logs for unauthorized usage
   - Trigger test workflow to validate new key

3. **Within 24 hours**:
   - Review all workflows using that secret
   - Check for suspicious activity
   - Document incident

4. **Follow-up**:
   - Review secret access permissions
   - Implement additional monitoring if needed
   - Update rotation schedule

---

## Checklist Summary

Before pushing to GitHub and triggering CI:

- [ ] All required secrets added to repository
- [ ] Secret names match exactly (case-sensitive)
- [ ] Secret values are valid and not expired
- [ ] Secrets tested locally with `.env` file
- [ ] `.env` file is gitignored (never committed)
- [ ] Workflow file references secrets correctly: `${{ secrets.NAME }}`
- [ ] Branch protection enabled on main/develop
- [ ] Rotation schedule documented

---

**Last Updated**: 2025-11-04  
**Maintainer**: TEA Agent (Murat)  
**Related Docs**: [`ci.md`](./ci.md), [`.env.example`](../.env.example)
