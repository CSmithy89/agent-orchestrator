<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <story>
    <id>4-7</id>
    <title>Sprint Status File Generation</title>
    <epic>epic-4</epic>
    <description>
      Generate sprint-status.yaml file to track all epics and stories with metadata for workflow management.
      The sprint status file serves as the single source of truth for tracking development progress throughout the sprint.
    </description>
  </story>

  <technical-context>
    <yaml-structure>
      <description>
        Sprint status YAML file structure with project metadata, status definitions, and development status tracking.
      </description>
      <example><![CDATA[
# Sprint Status Tracking
# Generated by sprint-planning workflow
# Date: YYYY-MM-DD

generated: YYYY-MM-DD
project: Agent Orchestrator
project_key: agent-orchestrator
tracking_system: file-system
story_location: "{project-root}/docs/stories"

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic exists in epic file but not contexted
#   - contexted: Epic tech context created (required before drafting stories)
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - drafted: Story file created in stories folder
#   - ready-for-dev: Draft approved and story context created
#   - in-progress: Developer actively working on implementation
#   - review: Under SM review (via code-review workflow)
#   - done: Story completed
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - completed: Retrospective has been done
#
# WORKFLOW NOTES:
# ===============
# - Epics should be 'contexted' before stories can be 'drafted'
# - Stories can be worked in parallel if team capacity allows
# - SM typically drafts next story after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', SM reviews, then Dev moves to 'done'

development_status:
  # Epic 4: Solutioning Phase Automation
  epic-4: contexted
  4-1-solutioning-data-models-story-schema: done
  4-2-bob-agent-infrastructure-context-builder: done
  4-3-solutioning-workflow-engine-foundation: done
  4-4-epic-formation-story-decomposition-combined: done
  4-5-dependency-detection-graph-generation-combined: done
  4-6-story-validation-quality-check: done
  4-7-sprint-status-file-generation: in-progress
  4-8-story-file-writer-epics-document-generator: backlog
  4-9-implementation-readiness-gate-validation: backlog
  epic-4-retrospective: optional
]]></example>
    </yaml-structure>

    <status-definitions>
      <epic-status>
        <status value="backlog">Epic exists in epic file but not contexted</status>
        <status value="contexted">Epic tech context created (required before drafting stories)</status>
      </epic-status>
      <story-status>
        <status value="backlog">Story only exists in epic file</status>
        <status value="drafted">Story file created in stories folder</status>
        <status value="ready-for-dev">Draft approved and story context created</status>
        <status value="in-progress">Developer actively working on implementation</status>
        <status value="review">Under SM review (via code-review workflow)</status>
        <status value="done">Story completed</status>
      </story-status>
      <retrospective-status>
        <status value="optional">Can be completed but not required</status>
        <status value="completed">Retrospective has been done</status>
      </retrospective-status>
    </status-definitions>

    <implementation-requirements>
      <requirement>
        Create SprintStatusGenerator service class in backend/src/solutioning/sprint-status-generator.ts
      </requirement>
      <requirement>
        Implement generateSprintStatus(result: SolutioningResult, projectName: string): string method
      </requirement>
      <requirement>
        Generate YAML header with project metadata (date, name, key, tracking system, story location)
      </requirement>
      <requirement>
        Include comprehensive status definitions comment block
      </requirement>
      <requirement>
        Include workflow notes comment block for SM guidance
      </requirement>
      <requirement>
        Generate development_status section with hierarchical epic/story structure
      </requirement>
      <requirement>
        Track epic status (backlog or contexted)
      </requirement>
      <requirement>
        Track story status (backlog by default for newly generated stories)
      </requirement>
      <requirement>
        Include retrospective status (optional) for each epic
      </requirement>
      <requirement>
        Format as valid YAML that can be parsed by standard YAML libraries
      </requirement>
      <requirement>
        Integrate with SolutioningOrchestrator after validation step (Step 8)
      </requirement>
      <requirement>
        Save generated YAML to docs/sprint-status.yaml with UTF-8 encoding
      </requirement>
      <requirement>
        Log file save confirmation with path
      </requirement>
      <requirement>
        Handle file write errors gracefully
      </requirement>
    </implementation-requirements>

    <data-flow>
      <step number="1">Receive SolutioningResult with epics and stories from orchestrator</step>
      <step number="2">Extract project name from input parameter</step>
      <step number="3">Generate YAML header with current date and project metadata</step>
      <step number="4">Generate status definitions comment block</step>
      <step number="5">Generate workflow notes comment block</step>
      <step number="6">Generate development_status section</step>
      <step number="7">For each epic: add epic entry (status: backlog)</step>
      <step number="8">For each story in epic: add story entry (status: backlog)</step>
      <step number="9">For each epic: add retrospective entry (status: optional)</step>
      <step number="10">Format as valid YAML with proper indentation</step>
      <step number="11">Save to docs/sprint-status.yaml</step>
      <step number="12">Log save confirmation</step>
    </data-flow>

    <testing-requirements>
      <test-scenario>Generate YAML with minimal SolutioningResult (1 epic, 1 story)</test-scenario>
      <test-scenario>Generate YAML with multiple epics and stories</test-scenario>
      <test-scenario>Verify project metadata included (date, name, key, tracking system)</test-scenario>
      <test-scenario>Verify status definitions header included</test-scenario>
      <test-scenario>Verify workflow notes included</test-scenario>
      <test-scenario>Verify epic status tracking (backlog status)</test-scenario>
      <test-scenario>Verify story status tracking (backlog status)</test-scenario>
      <test-scenario>Verify retrospective status included (optional)</test-scenario>
      <test-scenario>Parse generated YAML with yaml library to verify validity</test-scenario>
      <test-scenario>Verify YAML structure matches expected format</test-scenario>
      <test-scenario>Test timestamp formatting (YYYY-MM-DD)</test-scenario>
      <test-scenario>Test hierarchical epic/story structure</test-scenario>
    </testing-requirements>

    <integration-points>
      <point>
        SolutioningOrchestrator: Add generation step after validation (Step 8)
      </point>
      <point>
        SolutioningResult: Use epics and stories from result
      </point>
      <point>
        File System: Write to docs/sprint-status.yaml with fs.writeFile
      </point>
      <point>
        Logging: Log file save confirmation with path
      </point>
    </integration-points>
  </technical-context>

  <dependencies>
    <dependency>
      <story-id>4-4</story-id>
      <description>Epic Formation & Story Decomposition provides epics and stories</description>
      <status>done</status>
    </dependency>
    <dependency>
      <story-id>4-5</story-id>
      <description>Dependency Detection & Graph Generation provides dependency graph</description>
      <status>done</status>
    </dependency>
    <dependency>
      <story-id>4-6</story-id>
      <description>Story Validation & Quality Check provides validation results</description>
      <status>done</status>
    </dependency>
  </dependencies>

  <related-files>
    <file>
      <path>backend/src/solutioning/solutioning-orchestrator.ts</path>
      <relevance>Orchestrator that will call SprintStatusGenerator and save file</relevance>
    </file>
    <file>
      <path>backend/src/solutioning/types.ts</path>
      <relevance>Epic and Story type definitions</relevance>
    </file>
    <file>
      <path>docs/sprint-status.yaml</path>
      <relevance>Existing sprint status file (reference format)</relevance>
    </file>
  </related-files>

  <constraints>
    <constraint>Generated YAML must be valid and parseable by standard YAML libraries</constraint>
    <constraint>Status definitions must be comprehensive and match existing sprint-status.yaml format</constraint>
    <constraint>Story IDs must follow epic-specific naming convention (e.g., "4-1-story-name")</constraint>
    <constraint>Default status for newly generated epics/stories should be "backlog"</constraint>
    <constraint>Retrospective status should be "optional" by default</constraint>
    <constraint>File writing errors must be handled gracefully without crashing orchestrator</constraint>
  </constraints>

  <examples>
    <example-usage>
      <description>Generate sprint status from SolutioningResult</description>
      <code><![CDATA[
const generator = new SprintStatusGenerator();
const yaml = generator.generateSprintStatus(solutioningResult, 'Agent Orchestrator');
await fs.writeFile('docs/sprint-status.yaml', yaml, 'utf-8');
console.log('Sprint status saved to docs/sprint-status.yaml');
]]></code>
    </example-usage>

    <example-yaml-output>
      <description>Example generated YAML for 2 epics with multiple stories</description>
      <output><![CDATA[
# Sprint Status Tracking
# Generated by sprint-planning workflow
# Date: 2025-11-13

generated: 2025-11-13
project: Agent Orchestrator
project_key: agent-orchestrator
tracking_system: file-system
story_location: "{project-root}/docs/stories"

# STATUS DEFINITIONS...
# (full definitions block)

development_status:
  # Epic 1: Foundation & Core Engine
  epic-1: backlog
  1-1-project-repository-structure: backlog
  1-2-workflow-yaml-parser: backlog
  epic-1-retrospective: optional

  # Epic 2: Analysis Phase Automation
  epic-2: backlog
  2-1-confidence-based-decision-engine: backlog
  2-2-escalation-queue-system: backlog
  epic-2-retrospective: optional
]]></output>
    </example-yaml-output>
  </examples>
</story-context>
