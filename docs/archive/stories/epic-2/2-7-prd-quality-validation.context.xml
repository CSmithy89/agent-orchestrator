<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>7</storyId>
    <title>PRD Quality Validation</title>
    <status>drafted</status>
    <generatedAt>2025-11-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-7-prd-quality-validation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>PRD workflow</asA>
    <iWant>to validate generated PRD quality before completion</iWant>
    <soThat>output meets >85% completeness standard</soThat>
    <tasks>
      - Task 1: Implement PRDValidator class structure (AC: #1)
      - Task 2: Implement section presence validation (AC: #2)
      - Task 3: Implement requirements clarity validation (AC: #3)
      - Task 4: Implement success criteria validation (AC: #4)
      - Task 5: Implement feature acceptance criteria validation (AC: #5)
      - Task 6: Implement contradiction and gap detection (AC: #6)
      - Task 7: Implement completeness score calculation (AC: #7, #8)
      - Task 8: **WRITE TESTS FIRST** - Unit tests for PRDValidator (AC: all) - **START HERE per ATDD**
      - Task 9: Integration tests with PRDWorkflowExecutor and PRDTemplateProcessor (AC: all)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Implement PRDValidator class with quality checks
    2. Verify all required sections present
    3. Check requirements clarity (no vague "handle X" requirements)
    4. Validate success criteria are measurable
    5. Ensure acceptance criteria for key features
    6. Check for contradictions or gaps
    7. Generate completeness score (target >85%)
    8. If score &lt;85%, identify gaps and regenerate missing content
    9. Log validation results for improvement
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Technical Specification - Epic 2: Analysis Phase Automation</title>
        <section>Story 2.7: PRD Quality Validation (lines 815-847, 904-913)</section>
        <snippet>Implements PRDValidator class with quality checks. Validates sections present, requirements clarity, measurable success criteria, acceptance criteria for key features, contradictions, gaps. Generates completeness score (0-100, target &gt;85%). Triggers regeneration if score &lt;85%.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Workflow Plugins - PRD Workflow</section>
        <snippet>PRDValidator is a Workflow Plugin component in the Orchestrator Core. Validates PRD quality after PRDTemplateProcessor generates content. Called by PRDWorkflowExecutor at workflow step "Quality Validation".</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Full PRD - Example document to validate</section>
        <snippet>Complete PRD document generated by Story 2.6 (PRDTemplateProcessor). Contains Executive Summary, Success Criteria, MVP Scope, Functional Requirements, Success Metrics. This is the document PRDValidator will validate.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.7 (lines 567-585)</section>
        <snippet>PRD Quality Validation story with 9 acceptance criteria. Validates generated PRD quality before completion to ensure &gt;85% completeness standard.</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-6-prd-template-content-generation.md</path>
        <title>Story 2.6: PRD Template & Content Generation</title>
        <section>Dev Notes - Learnings and Patterns</section>
        <snippet>Previous story that generated PRD content. Established patterns for workflow validators: location (backend/src/core/workflows/), dependency injection (StateManager), markdown parsing (regex for ## headers and FR-XXX requirements), ATDD approach (tests first).</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-5-prd-workflow-executor.md</path>
        <title>Story 2.5: PRD Workflow Executor</title>
        <section>PRDWorkflowExecutor integration</section>
        <snippet>Workflow orchestrator that calls PRDValidator after PRDTemplateProcessor completes. If validation score &lt;85%, triggers regeneration. Manages workflow state and completion.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/src/core/StateManager.ts</path>
        <kind>service</kind>
        <symbol>StateManager</symbol>
        <lines>full file</lines>
        <reason>PRDValidator uses StateManager.readFile() to read docs/PRD.md for validation. Dependency injection pattern - passed to constructor.</reason>
      </artifact>
      <artifact>
        <path>backend/src/core/workflows/prd-template-processor.ts</path>
        <kind>service</kind>
        <symbol>PRDTemplateProcessor</symbol>
        <lines>full file</lines>
        <reason>Story 2.6 implementation - provides class structure pattern, markdown parsing examples, and integration with PRDWorkflowExecutor. PRDValidator follows similar patterns.</reason>
      </artifact>
      <artifact>
        <path>backend/src/core/workflows/prd-workflow-executor.ts</path>
        <kind>service</kind>
        <symbol>PRDWorkflowExecutor</symbol>
        <lines>full file</lines>
        <reason>Orchestrates PRD workflow. Calls PRDValidator.validate() after PRDTemplateProcessor completes. If validation fails (score &lt;85%), triggers regeneration.</reason>
      </artifact>
      <artifact>
        <path>backend/tests/core/workflows/PRDTemplateProcessor.test.ts</path>
        <kind>test</kind>
        <symbol>PRDTemplateProcessor tests</symbol>
        <lines>full file</lines>
        <reason>Test patterns to follow for Story 2.7. ATDD approach: Task 8 (write tests first), test structure (describe blocks per AC), test fixtures (sample PRD content), >90% coverage target.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <dependency name="typescript" version="^5.3.0" usage="Type-safe development" />
        <dependency name="vitest" version="^1.0.0" usage="Testing framework - unit and integration tests" />
        <dependency name="@vitest/coverage-v8" version="^1.0.0" usage="Code coverage reporting (target >90%)" />
        <dependency name="@vitest/ui" version="^1.0.0" usage="Test UI for development" />
        <dependency name="eslint" version="^8.56.0" usage="Code linting" />
        <dependency name="@typescript-eslint/eslint-plugin" version="^6.20.0" usage="TypeScript linting rules" />
        <dependency name="@typescript-eslint/parser" version="^6.20.0" usage="TypeScript parser for ESLint" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - **ATDD Approach**: Start with Task 8 (write ALL unit tests first) before implementing code (Tasks 1-7). Tests should fail initially.
    - **Location**: Create backend/src/core/workflows/prd-validator.ts (same directory as prd-template-processor.ts)
    - **Dependency Injection**: Pass StateManager as constructor parameter (follow Story 2.6 pattern)
    - **TypeScript Strict Mode**: No `any` types, use explicit interfaces for all data structures
    - **Coverage Target**: >90% code coverage for PRDValidator (critical quality component)
    - **Markdown Parsing**: Extract ## headers for sections, FR-XXX format for requirements
    - **Scoring Algorithm**: Base 100 - deductions (missing section: -15, vague requirement: -5, gap: -3, contradiction: -5)
    - **Quality Gate**: passesQualityGate = true if score >=85 AND no high-severity clarity issues
    - **Error Handling**: Try-catch blocks with specific error types, helpful error messages
    - **Naming Conventions**: Classes (PascalCase), methods (camelCase), files (kebab-case)
    - **ESLint**: Must pass with no warnings before committing
    - **Integration**: PRDWorkflowExecutor → PRDTemplateProcessor → PRDValidator → regeneration (if score &lt;85%)
  </constraints>

  <interfaces>
    <interface>
      <name>PRDValidationResult</name>
      <kind>TypeScript interface</kind>
      <signature>
interface PRDValidationResult {
  completenessScore: number;     // 0-100, target >85
  sectionsPresent: string[];     // All required sections found
  sectionsMissing: string[];     // Required sections not found
  requirementsCount: number;     // Total functional requirements
  clarityIssues: ClarityIssue[]; // Vague/unclear requirements
  contradictions: string[];      // Conflicting requirements
  gaps: string[];                // Missing information
  passesQualityGate: boolean;    // True if score >85 and no high-severity issues
}
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
    <interface>
      <name>ClarityIssue</name>
      <kind>TypeScript interface</kind>
      <signature>
interface ClarityIssue {
  section: string;
  issue: string;
  severity: 'high' | 'medium' | 'low';
}
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
    <interface>
      <name>PRDValidator.validate</name>
      <kind>async method</kind>
      <signature>
async validate(prdFilePath: string): Promise&lt;PRDValidationResult&gt;
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
    <interface>
      <name>PRDValidator.validateSectionsPresent</name>
      <kind>private method</kind>
      <signature>
private validateSectionsPresent(content: string): { sectionsPresent: string[], sectionsMissing: string[] }
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
    <interface>
      <name>PRDValidator.validateRequirementsClarity</name>
      <kind>private method</kind>
      <signature>
private validateRequirementsClarity(content: string): ClarityIssue[]
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
    <interface>
      <name>PRDValidator.validateSuccessCriteria</name>
      <kind>private method</kind>
      <signature>
private validateSuccessCriteria(content: string): ClarityIssue[]
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
    <interface>
      <name>PRDValidator.validateAcceptanceCriteria</name>
      <kind>private method</kind>
      <signature>
private validateAcceptanceCriteria(content: string): ClarityIssue[]
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
    <interface>
      <name>PRDValidator.detectContradictions</name>
      <kind>private method</kind>
      <signature>
private detectContradictions(content: string): string[]
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
    <interface>
      <name>PRDValidator.identifyGaps</name>
      <kind>private method</kind>
      <signature>
private identifyGaps(content: string): string[]
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
    <interface>
      <name>PRDValidator.calculateCompletenessScore</name>
      <kind>private method</kind>
      <signature>
private calculateCompletenessScore(result: Partial&lt;PRDValidationResult&gt;): number
      </signature>
      <path>backend/src/core/workflows/prd-validator.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing uses Vitest framework with @vitest/coverage-v8 for code coverage. Test files located in backend/tests/ with same structure as src/. ATDD approach: write tests first (Task 8), then implementation (Tasks 1-7), then integration tests (Task 9). Target >90% coverage for validators. Test organization: describe blocks per acceptance criterion, beforeEach/afterEach hooks for setup/teardown. Mock dependencies (StateManager). Use test fixtures: valid PRD, PRD with gaps, PRD with vague requirements.
    </standards>
    <locations>
      - backend/tests/core/workflows/PRDValidator.test.ts (unit tests - create new)
      - backend/tests/integration/prd-workflow.test.ts (integration tests - update existing)
    </locations>
    <ideas>
      - AC #1: Test PRDValidator class instantiation with StateManager dependency
      - AC #2: Test validateSectionsPresent() with complete PRD (all sections present), missing sections, extra optional sections
      - AC #3: Test validateRequirementsClarity() with vague patterns ("handle X", "manage Y", "support Z", "improve W") and specific requirements
      - AC #4: Test validateSuccessCriteria() with measurable criteria (numbers, percentages) and subjective criteria
      - AC #5: Test validateAcceptanceCriteria() with features that have ACs vs missing ACs, testable AC keywords
      - AC #6: Test detectContradictions() with conflicting requirements, inconsistent terminology; identifyGaps() with missing user flows, incomplete descriptions
      - AC #7: Test calculateCompletenessScore() with various scenarios (perfect PRD=100, 1 missing section=85, 2 missing sections=70, vague requirements reduce score)
      - AC #8: Test score &lt;85 triggers gap identification for regeneration
      - AC #9: Test logValidationResults() outputs score, gaps, contradictions
      - Integration: Test PRDWorkflowExecutor → PRDTemplateProcessor → PRDValidator → regeneration flow
    </ideas>
  </tests>
</story-context>
