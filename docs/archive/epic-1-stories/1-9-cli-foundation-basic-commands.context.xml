<story-context id="bmad/bmm/workflows/4-implementation/story-context/1-9" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>9</storyId>
    <title>CLI Foundation - Basic Commands</title>
    <status>drafted</status>
    <generatedAt>2025-11-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-9-cli-foundation-basic-commands.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer using the orchestrator</asA>
    <iWant>command-line tools to control the orchestrator locally</iWant>
    <soThat>I can start workflows, check status, and debug issues</soThat>
    <tasks>
      <task id="1" ac="1">CLI framework setup and project structure</task>
      <task id="2" ac="2,3">Implement start-workflow command</task>
      <task id="3" ac="2,4">Implement status command</task>
      <task id="4" ac="2,5">Implement logs command</task>
      <task id="5" ac="2">Implement pause command</task>
      <task id="6" ac="2">Implement resume command</task>
      <task id="7" ac="2">Implement list-projects command</task>
      <task id="8">Implement list-agents command (bonus)</task>
      <task id="9">Implement state command (bonus)</task>
      <task id="10" ac="6">Color-coded output and formatting</task>
      <task id="11" ac="7">Help documentation</task>
      <task id="12" ac="8">Error handling and validation</task>
      <task id="13" ac="2,3,4">Integration with WorkflowEngine and StateManager</task>
      <task id="14">Testing and validation</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Implement CLI using commander.js or yargs</criterion>
    <criterion id="2">Commands: start-workflow, pause, resume, status, list-projects</criterion>
    <criterion id="3">orchestrator start-workflow --project &lt;id&gt; --workflow &lt;path&gt;</criterion>
    <criterion id="4">orchestrator status --project &lt;id&gt; shows current phase and progress</criterion>
    <criterion id="5">orchestrator logs --project &lt;id&gt; --tail shows recent logs</criterion>
    <criterion id="6">Color-coded output for better readability</criterion>
    <criterion id="7">--help documentation for each command</criterion>
    <criterion id="8">Proper error handling with actionable messages</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>CLI Commands</section>
        <snippet>Defines all CLI commands with signatures: start-workflow, pause, resume, status, logs, list-projects, list-agents, state. Includes command structure, parameters, and expected behavior for local orchestrator control.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.9: CLI Foundation</section>
        <snippet>User story and acceptance criteria for CLI implementation. Prerequisites: Story 1.7 (WorkflowEngine), Story 1.5 (StateManager). Commander.js or yargs for framework, color-coded output required.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Core Kernel Components - CLI Interface</section>
        <snippet>CLI is part of Core Kernel (Epic 1) providing local command-line control. Tight integration with WorkflowEngine for execution control and StateManager for state queries.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Essential Infrastructure</section>
        <snippet>Basic CLI for local orchestrator control included in MVP scope. Developer-focused tool for workflow management, status monitoring, and debugging without web dashboard dependency.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>backend/src/config/ProjectConfig.ts</path>
        <kind>module</kind>
        <symbol>ProjectConfig</symbol>
        <lines>*</lines>
        <reason>CLI needs to load project configuration from .bmad/project-config.yaml to validate project IDs and pass config to WorkflowEngine</reason>
      </artifact>
      <artifact>
        <path>backend/src/core/WorkflowParser.ts</path>
        <kind>module</kind>
        <symbol>WorkflowParser</symbol>
        <lines>*</lines>
        <reason>CLI will use WorkflowParser (via WorkflowEngine) to parse and validate workflow.yaml files before execution</reason>
      </artifact>
      <artifact>
        <path>backend/src/core/WorktreeManager.ts</path>
        <kind>module</kind>
        <symbol>WorktreeManager</symbol>
        <lines>*</lines>
        <reason>Optional integration for list-agents command to show worktree status and active development branches</reason>
      </artifact>
      <artifact>
        <path>backend/src/types/workflow.types.ts</path>
        <kind>types</kind>
        <symbol>WorkflowConfig, WorkflowState</symbol>
        <lines>*</lines>
        <reason>CLI commands need WorkflowState type to display status, current step, and workflow progress information</reason>
      </artifact>
      <artifact>
        <path>backend/src/types/ProjectConfig.ts</path>
        <kind>types</kind>
        <symbol>ProjectConfig</symbol>
        <lines>*</lines>
        <reason>Type definitions for project configuration used in CLI command validation and project loading</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <commander version="^11.0.0">CLI framework - declarative command definition with built-in help generation</commander>
        <chalk version="^5.0.0">Terminal colors for better UX - color-coded output by status</chalk>
        <tsx version="^4.0.0">TypeScript execution for development - already in devDependencies</tsx>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">CLI must integrate tightly with WorkflowEngine (Story 1.7) for start/pause/resume and StateManager (Story 1.5) for status queries</constraint>
    <constraint type="architecture">Use commander.js for CLI framework (preferred over yargs for simpler API and better TypeScript support)</constraint>
    <constraint type="ux">Color-coded output required: green (success), yellow (warning), red (error), cyan (info), gray (debug)</constraint>
    <constraint type="ux">Support --no-color flag for CI/CD environments that don't support ANSI colors</constraint>
    <constraint type="error-handling">All errors must provide actionable resolution steps, not just generic error messages</constraint>
    <constraint type="error-handling">Exit codes: 0 for success, 1 for error - required for scripting and automation</constraint>
    <constraint type="testing">Write unit tests for each command handler, integration tests for workflow lifecycle</constraint>
    <constraint type="project-structure">CLI entry point: backend/src/cli/index.ts, commands in backend/src/cli/commands/</constraint>
    <constraint type="dependencies">Prerequisites: Story 1.7 (WorkflowEngine), Story 1.5 (StateManager), Story 1.1 (ProjectConfig) must be complete or interface-compatible</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>WorkflowEngine.execute()</name>
      <kind>method</kind>
      <signature>async execute(): Promise&lt;void&gt;</signature>
      <path>backend/src/core/WorkflowEngine.ts</path>
      <description>Start workflow execution from beginning - called by start-workflow command</description>
    </interface>
    <interface>
      <name>WorkflowEngine.resumeFromState()</name>
      <kind>method</kind>
      <signature>async resumeFromState(state: WorkflowState): Promise&lt;void&gt;</signature>
      <path>backend/src/core/WorkflowEngine.ts</path>
      <description>Resume workflow from saved state - called by resume command after loading state</description>
    </interface>
    <interface>
      <name>StateManager.loadState()</name>
      <kind>method</kind>
      <signature>async loadState(projectId: string): Promise&lt;WorkflowState | null&gt;</signature>
      <path>backend/src/core/StateManager.ts</path>
      <description>Load workflow state for project - called by status, resume, and state commands</description>
    </interface>
    <interface>
      <name>StateManager.saveState()</name>
      <kind>method</kind>
      <signature>async saveState(state: WorkflowState): Promise&lt;void&gt;</signature>
      <path>backend/src/core/StateManager.ts</path>
      <description>Save workflow state - called by pause command to persist paused status</description>
    </interface>
    <interface>
      <name>StateManager.getProjectPhase()</name>
      <kind>method</kind>
      <signature>async getProjectPhase(projectId: string): Promise&lt;string&gt;</signature>
      <path>backend/src/core/StateManager.ts</path>
      <description>Get current project phase (Analysis, Planning, Solutioning, Implementation) - called by status command</description>
    </interface>
    <interface>
      <name>ProjectConfig.load()</name>
      <kind>static-method</kind>
      <signature>static async load(projectId: string): Promise&lt;ProjectConfig&gt;</signature>
      <path>backend/src/config/ProjectConfig.ts</path>
      <description>Load project configuration from .bmad/project-config.yaml - called by all commands to validate project ID</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Vitest for unit tests (Epic 1, Story 1.11). CLI commands should be tested in isolation with mocked dependencies (WorkflowEngine, StateManager, ProjectConfig). Integration tests should verify workflow lifecycle: start → pause → resume → status. Test error handling for all error types with appropriate exit codes. Test color output with and without --no-color flag.
    </standards>
    <locations>
      backend/tests/cli/ - CLI unit tests
      backend/tests/cli/commands.test.ts - Command handler tests
      backend/tests/integration/cli-workflow.test.ts - Integration tests for CLI + WorkflowEngine + StateManager
    </locations>
    <ideas>
      <idea ac="1">Test commander.js setup and command registration</idea>
      <idea ac="2,3">Test start-workflow command with valid/invalid project and workflow paths</idea>
      <idea ac="2,4">Test status command displays phase, workflow, step, and status correctly</idea>
      <idea ac="2,5">Test logs command with --tail flag and missing log files</idea>
      <idea ac="2">Test pause command updates state and signals workflow engine</idea>
      <idea ac="2">Test resume command loads state and continues from last step</idea>
      <idea ac="2">Test list-projects command scans projects directory and displays table</idea>
      <idea ac="6">Test color output (with/without --no-color) for all commands</idea>
      <idea ac="7">Test help documentation for each command (--help)</idea>
      <idea ac="8">Test error handling: ProjectNotFoundError, WorkflowNotFoundError, WorkflowParseError, WorkflowExecutionError</idea>
      <idea>Integration test: Start workflow → Pause → Resume → Check status (complete lifecycle)</idea>
      <idea>Integration test: Start workflow → Error → Check logs (error recovery)</idea>
    </ideas>
  </tests>
</story-context>
