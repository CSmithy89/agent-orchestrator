name: Claude Auto-Fix CodeRabbit Suggestions

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  auto-fix-coderabbit:
    # Only run if CodeRabbit posted a review or comment
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.user.login == 'coderabbitai[bot]') ||
      (github.event_name == 'issue_comment' && github.event.comment.user.login == 'coderabbitai[bot]' && github.event.issue.pull_request)

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.event.issue.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "Claude Code Bot"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"

      - name: Run Claude to Fix CodeRabbit Suggestions
        id: claude-fix
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}

            CodeRabbit has reviewed this PR and provided suggestions. Your task is to:

            1. Read the CodeRabbit review comments using `gh pr view` and `gh api` commands
            2. Analyze each suggestion carefully
            3. Implement the fixes that are valid and improve code quality
            4. Make the necessary code changes using your file editing tools
            5. Commit the changes with a clear message like "fix: apply CodeRabbit suggestions"
            6. Push the changes to the PR branch

            Important guidelines:
            - Only apply suggestions that are genuinely improvements
            - If a suggestion is unclear or potentially incorrect, skip it and leave a comment explaining why
            - Test that your changes don't break anything (review tests if available)
            - Use the repository's code style and conventions
            - Group related fixes into logical commits

            After making changes, leave a comment on the PR summarizing what you fixed using `gh pr comment`.

          claude_args: |
            --allowed-tools "Bash(gh pr:*),Bash(gh api:*),Bash(gh issue:*),Bash(git:*),Read,Edit,Write,Grep,Glob"

      - name: Comment on PR if no changes needed
        if: failure()
        run: |
          gh pr comment ${{ github.event.pull_request.number || github.event.issue.number }} \
            --body "ðŸ‘‹ I reviewed the CodeRabbit suggestions but encountered an issue while trying to apply them. Please review the workflow logs for details."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
