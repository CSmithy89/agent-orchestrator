name: Test Pipeline (Disabled - Epic 6)

# TEMPORARILY DISABLED: This workflow is for future E2E/Playwright testing (Epic 6)
# Currently conflicts with ci.yml and references dashboard workspace that doesn't exist yet
# Re-enable when implementing Epic 6 frontend and E2E tests
on:
  workflow_dispatch:  # Manual trigger only

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  test-unit:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        workspace: [backend, dashboard]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test --workspace=${{ matrix.workspace }}
        env:
          NODE_ENV: test

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.workspace }}
          path: ${{ matrix.workspace }}/coverage
          retention-days: 30

  test-e2e:
    name: E2E Tests (Shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Run E2E tests (parallel shard)
        run: npm run test:e2e -- --shard=${{ matrix.shard }}/4
        env:
          NODE_ENV: test
          API_BASE_URL: http://localhost:3000

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-shard-${{ matrix.shard }}
          path: |
            tests/reports/
            test-results/
            playwright-report/
          retention-days: 30

      - name: Upload traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-traces-shard-${{ matrix.shard }}
          path: test-results/**/*.zip
          retention-days: 30

  burn-in:
    name: Burn-In (Flaky Test Detection)
    runs-on: ubuntu-latest
    needs: [test-e2e]
    timeout-minutes: 45
    if: github.event_name == 'pull_request' && github.base_ref == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run burn-in loop (10 iterations)
        run: ./scripts/burn-in.sh
        env:
          NODE_ENV: test

      - name: Upload burn-in failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: burn-in-failures
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [test-unit, test-e2e]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate summary
        run: |
          echo "## Test Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.test-unit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.test-e2e.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Burn-in: ${{ needs.burn-in.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.test-e2e.result }}" == "failure" ]]; then
            echo "### ⚠️ E2E Test Failures" >> $GITHUB_STEP_SUMMARY
            echo "Check uploaded artifacts for traces, screenshots, and videos." >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.burn-in.result }}" == "failure" ]]; then
            echo "### ❌ Flaky Tests Detected" >> $GITHUB_STEP_SUMMARY
            echo "Tests failed during burn-in loop. Fix non-deterministic behavior before merging." >> $GITHUB_STEP_SUMMARY
          fi
